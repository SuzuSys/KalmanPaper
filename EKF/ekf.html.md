# Extended Kalman Filter


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## 概要

濾波推定値 $\hat{\mathbf w}\_{t/t}$
$$\hat{\mathbf w}\_{t/t}=\hat{\mathbf w}\_{t/t-1}+\frac{1}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\mathbf P\_{t/t-1}\mathbf x_t(y_t-\sigma_t)$$

推定誤差共分散行列 **P**<sub>*t*/*t*</sub>
$$\sigma_t=\sigma(\hat{\mathbf w}\_{t/t-1}^T\mathbf x_t)$$
$$\mathbf P\_{t/t}=\mathbf P\_{t/t-1}-\frac{\sigma_t(1-\sigma_t)}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}(\mathbf P\_{t/t-1}\mathbf x_t)(\mathbf P\_{t/t-1}\mathbf x_t)^T$$

各変数の情報の利用

<table style="width:100%;">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th><span class="math inline"> </span></th>
<th><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em></sub></span></th>
<th><span class="math inline">$\hat{\mathbf w}_{t/t}$</span></th>
<th><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em> − 1</sub></span></th>
<th><span class="math inline">$\hat{\mathbf w}_{t/t-1}$</span></th>
<th><span
class="math inline"><strong>x</strong><sub><em>t</em></sub></span></th>
<th><span
class="math inline"><em>y</em><sub><em>t</em></sub></span></th>
</tr>
</thead>
<tbody>
<tr>
<td><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em></sub></span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
</tr>
<tr>
<td><span class="math inline">$\hat{\mathbf w}_{t/t}$</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
</tr>
</tbody>
</table>

## ラプラス近似による導出

### 1. *p*(**w**<sub>*t*</sub> ∣ **Y**<sub>*t*</sub>)

$$
p(\mathbf w_t\mid \mathbf Y_t)=\frac{p(y_t\mid\mathbf w_t)p(\mathbf w_t\mid\mathbf Y\_{t-1})}{p(y_t\mid\mathbf Y\_{t-1})}
$$

$$p(\mathbf w_t\mid\mathbf Y\_{t-1})=\mathcal N(\mathbf w_t\mid\hat{\mathbf w}\_{t/t-1},\mathbf P\_{t/t-1})$$

よって、

$$
\begin{equation\*}
p(\mathbf w_t\mid \mathbf Y_t)=
\begin{cases}
\sigma(\mathbf w_t^T\mathbf x_t)\mathcal N(\mathbf w_t\mid\hat{\mathbf w}\_{t/t-1},\mathbf P\_{t/t-1}) &( y_t=1) \\
\\1-\sigma(\mathbf w_t^T\mathbf x_t)\\\mathcal N(\mathbf w_t\mid\hat{\mathbf w}\_{t/t-1},\mathbf P\_{t/t-1}) & (y_t=0)
\end{cases}
\end{equation\*}
$$

### 2. $\hat{\mathbf w}\_{t/t}$

**w**<sub>*t*</sub> をMAP推定する。
ln *p*(**w**<sub>*t*</sub> ∣ **Y**<sub>*t*</sub>) の微分を **0**
と置く。

$$
\begin{split}
&\phantom{=}\frac{\partial}{\partial \mathbf w_t}\ln p(\mathbf w_t\mid\mathbf Y_t) \\
&= \frac{\partial}{\partial \mathbf w_t}\ln\left\[\sigma(\mathbf w_t^T\mathbf x_t)^{y_t}\\1-\sigma(\mathbf w_t^T\mathbf x_t)\\^{1-y_t}\mathcal N(\mathbf w_t\mid\hat{\mathbf w}\_{t/t-1},\mathbf P\_{t/t-1})\right\] \\
&= \frac{\partial}{\partial \mathbf w_t}y_t\ln\sigma(\mathbf w_t^T\mathbf x_t)+\frac{\partial}{\partial\mathbf w_t}(1-y_t)\ln\\1-\sigma(\mathbf w_t^T\mathbf x_t)\\ \\
&\phantom{=} +\frac{\partial}{\partial\mathbf w_t}\ln\mathcal N(\mathbf w_t\mid\hat{\mathbf w}\_{t/t-1},\mathbf P\_{t/t-1}) \\
&= \left\\y_t-\sigma(\mathbf w_t^T\mathbf x_t)\right\\\mathbf x_t-\mathbf P\_{t/t-1}^{-1}(\mathbf w_t-\hat{\mathbf w}\_{t/t-1})
\end{split}
$$

ここで、*σ*(**w**<sub>*t*</sub><sup>*T*</sup>**x**<sub>*t*</sub>)
をテイラー展開で一次近似する。

$\sigma_t=\sigma(\hat{\mathbf w}\_{t/t-1}^T\mathbf x_t)$ とする。

$$
\begin{split}
\sigma(\mathbf w_t^T\mathbf x_t) &\simeq \sigma_t+\left.\frac{\partial\sigma(\mathbf w_t^T\mathbf x_t)}{\partial \mathbf w_t}\right|\_{\mathbf w_t=\hat{\mathbf w}\_{t/t-1}}(\mathbf w_t-\hat{\mathbf w}\_{t/t-1}) \\
&\phantom{00}=\sigma_t+\sigma_t\\1-\sigma_t\\(\mathbf w_t-\hat{\mathbf w}\_{t/t-1})^T\mathbf x_t
\end{split}
$$

*σ*(**w**<sub>*t*</sub><sup>*T*</sup>**x**<sub>*t*</sub>) を
*σ*<sub>*t*</sub> に置き換え、**0** とおく。

$$
\begin{split}
&\phantom{=}\frac{\partial}{\partial \mathbf w_t}\ln p(\mathbf w_t\mid\mathbf Y_t) \\
&=\left\[ y_t-\sigma_t-\sigma_t\left\\1-\sigma_t\right\\(\mathbf w_t-\hat{\mathbf w}\_{t/t-1})^T\mathbf x_t \right\]\mathbf x_t-\mathbf P\_{t/t-1}^{-1}(\mathbf w_t-\hat{\mathbf w}\_{t/t-1}) \\
&=(y_t-\sigma_t)\mathbf x_t-\left\[\mathbf P\_{t/t-1}^{-1}+\sigma_t(1-\sigma_t)\mathbf x_t\mathbf x_t^T\right\](\mathbf w_t-\hat{\mathbf w}\_{t/t-1}) \\
&=\mathbf 0
\end{split}
$$

$$
\begin{split}
\mathbf w_t &= \hat{\mathbf w}\_{t/t-1}+\left\[\mathbf P\_{t/t-1}^{-1}+\sigma_t\left\\1-\sigma_t\right\\\mathbf x_t\mathbf x_t^T\right\]^{-1}\mathbf x_t(y_t-\sigma_t) \\
&=\hat{\mathbf w}\_{t/t-1}+\left\[\mathbf P\_{t/t-1}-\frac{\sigma_t(1-\sigma_t)\mathbf P\_{t/t-1}\mathbf x_t\mathbf x_t^T\mathbf P\_{t/t-1}}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\right\]\mathbf x_t(y_t-\sigma_t) \\
&=\hat{\mathbf w}\_{t/t-1}+\left\[\mathbf P\_{t/t-1}\mathbf x_t-\frac{\sigma_t(1-\sigma_t)\mathbf P\_{t/t-1}\mathbf x_t\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\right\](y_t-\sigma_t) \\
&=\hat{\mathbf w}\_{t/t-1}+\left\[1-\frac{\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\right\]\mathbf P\_{t/t-1}\mathbf x_t(y_t-\sigma_t) \\
&=\hat{\mathbf w}\_{t/t-1}+\frac{1}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\mathbf P\_{t/t-1}\mathbf x_t(y_t-\sigma_t)
\end{split}
$$

よって **w**<sub>*t*</sub> のMAP推定値 $\hat{\mathbf w}\_{t/t}$ は

$$\hat{\mathbf w}\_{t/t}=\hat{\mathbf w}\_{t/t-1}+\frac{1}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\mathbf P\_{t/t-1}\mathbf x_t(y_t-\sigma_t)$$

となる。

### 3. **P**<sub>*t*/*t*</sub>

$\hat{\mathbf w}\_{t/t-1}$ を
*p*(**w**<sub>*t*</sub> ∣ **Y**<sub>*t*</sub>) のピークとすると
**P**<sub>*t*/*t*</sub> が得られる。

（ $\hat{\mathbf w}\_{t/t}$ をピークとするのが本来のラプラス近似）

$$
\begin{split}
\mathbf P\_{t/t}^{-1} &= \left.-\frac{\partial^2}{\partial\mathbf w_t^2} \ln p(\mathbf w_t\mid\mathbf Y_t)\right|\_{\mathbf w_t=\hat{\mathbf w}\_{t/t-1}} \\
&= \left. -\frac{\partial}{\partial\mathbf w_t}\left\[\left\\y_t-\sigma(\mathbf w_t^T\mathbf x_t)\right\\\mathbf x_t-\mathbf P\_{t/t-1}^{-1}(\mathbf w_t-\hat{\mathbf w}\_{t/t-1})\right\]\right|\_{\mathbf w_t=\hat{\mathbf w}\_{t/t-1}} \\
&= \mathbf P\_{t/t-1}^{-1}+\sigma_t(1-\sigma_t)\mathbf x_t\mathbf x_t^T
\end{split}
$$

Sherman-Morrison の公式によって、 **P**<sub>*t*/*t*</sub> が得られる。

$$
\mathbf P\_{t/t}=\mathbf P\_{t/t-1}-\frac{\sigma_t(1-\sigma_t)}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}(\mathbf P\_{t/t-1}\mathbf x_t)(\mathbf P\_{t/t-1}\mathbf x_t)^T
$$

## 関数等

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/EKF.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### Ptt

>  Ptt (Ptm:jaxtyping.Float[Array,'NN'], w:jaxtyping.Float[Array,'N'],
>           x:jaxtyping.Float[Array,'N'])

* * 推定誤差共分散行列 **P**<sub>*t*/*t*</sub>
$$\sigma_t=\sigma(\hat{\mathbf w}\_{t/t-1}^T\mathbf x_t)$$
$$\mathbf P\_{t/t}=\mathbf P\_{t/t-1}-\frac{\sigma_t(1-\sigma_t)}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}(\mathbf P\_{t/t-1}\mathbf x_t)(\mathbf P\_{t/t-1}\mathbf x_t)^T$$
* *

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Ptm</td>
<td>Float[Array, ‘N N’]</td>
<td><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em> − 1</sub></span></td>
</tr>
<tr>
<td>w</td>
<td>Float[Array, ‘N’]</td>
<td><span class="math inline">$\hat{\mathbf w}_{t/t-1}$</span></td>
</tr>
<tr>
<td>x</td>
<td>Float[Array, ‘N’]</td>
<td><span
class="math inline"><strong>x</strong><sub><em>t</em></sub></span></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Float[Array, ‘N N’]</strong></td>
<td><strong><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em></sub></span></strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/EKF.py#L35"
target="_blank" style="float:right; font-size:smaller">source</a>

### wtt

>  wtt (Ptm:jaxtyping.Float[Array,'NN'], w:jaxtyping.Float[Array,'N'],
>           x:jaxtyping.Float[Array,'N'], y:jaxtyping.Float[Array,'N'])

* * 濾波推定値 $\hat{\mathbf w}\_{t/t}$
$$\hat{\mathbf w}\_{t/t}=\hat{\mathbf w}\_{t/t-1}+\frac{1}{1+\sigma_t(1-\sigma_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\mathbf P\_{t/t-1}\mathbf x_t(y_t-\sigma_t)$$
* *

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Ptm</td>
<td>Float[Array, ‘N N’]</td>
<td><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em> − 1</sub></span></td>
</tr>
<tr>
<td>w</td>
<td>Float[Array, ‘N’]</td>
<td><span class="math inline">$\hat{\mathbf w}_{t/t-1}$</span></td>
</tr>
<tr>
<td>x</td>
<td>Float[Array, ‘N’]</td>
<td><span
class="math inline"><strong>x</strong><sub><em>t</em></sub></span></td>
</tr>
<tr>
<td>y</td>
<td>Float[Array, ‘N’]</td>
<td><span
class="math inline"><em>y</em><sub><em>t</em></sub></span></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Float[Array, ‘N’]</strong></td>
<td><strong><span class="math inline">$\hat{\mathbf
w}_{t/t}$</span></strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/EKF.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### EKF_out

>  EKF_out (W:jaxtyping.Float[Array,'TN'], P:jaxtyping.Float[Array,'TNN'])

* * [`EKF`](https://SuzuSys.github.io/KalmanPaper/EKF/ekf.html#ekf)
関数の返り値

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th><span class="math inline"> </span></th>
<th>Type</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>W</td>
<td>Float[Array, ‘T N’]</td>
<td><span class="math inline">$\{\hat{\mathbf
w}_{t/t}\}_{t=0,\ldots,T-1}$</span></td>
</tr>
<tr>
<td>P</td>
<td>Float[Array, ‘T N N’]</td>
<td><span
class="math inline">{<strong>P</strong><sub><em>t</em>/<em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
</tbody>
</table>

* *

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/EKF.py#L66"
target="_blank" style="float:right; font-size:smaller">source</a>

### EKF

>  EKF (N:int, T:int, x:jaxtyping.Float[Array,'{T}{N}'],
>           y:jaxtyping.Float[Array,'{T}{N}'],
>           G:jaxtyping.Float[Array,'{N}{N}'], w0:jaxtyping.Float[Array,'{N}'],
>           P0:jaxtyping.Float[Array,'{N}{N}'])

* * 拡張カルマンフィルタ * *

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>N</td>
<td>int</td>
<td><span class="math inline"><em>N</em></span></td>
</tr>
<tr>
<td>T</td>
<td>int</td>
<td><span class="math inline"><em>T</em></span></td>
</tr>
<tr>
<td>x</td>
<td>Float[Array, ‘{T} {N}’]</td>
<td><span
class="math inline">{<strong>x</strong><sub><em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
<tr>
<td>y</td>
<td>Float[Array, ‘{T} {N}’]</td>
<td><span
class="math inline">{<em>y</em><sub><em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
<tr>
<td>G</td>
<td>Float[Array, ‘{N} {N}’]</td>
<td><span class="math inline"><strong>Γ</strong></span></td>
</tr>
<tr>
<td>w0</td>
<td>Float[Array, ‘{N}’]</td>
<td><span class="math inline">$\hat{\mathbf w}_{0/-1}$</span></td>
</tr>
<tr>
<td>P0</td>
<td>Float[Array, ‘{N} {N}’]</td>
<td><span
class="math inline"><strong>P</strong><sub>0/ − 1</sub></span></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>EKF_out</strong></td>
<td></td>
</tr>
</tbody>
</table>
