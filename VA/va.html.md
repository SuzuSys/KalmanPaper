# Variational Approximation


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## 概要

濾波推定値 $\hat{\mathbf w}\_{t/t}$
$$\hat{\mathbf w}\_{t/t}=\mathbf P\_{t/t}\left(\mathbf P\_{t/t-1}^{-1}\hat{\mathbf w}\_{t/t-1}+(y_t-1/2)\mathbf x_t\right)$$

推定誤差共分散行列 **P**<sub>*t*/*t*</sub>

$$\mathbf P\_{t/t}=\mathbf P\_{t/t-1}-\frac{2\lambda(\xi_t)}{1+2\lambda(\xi_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\left(\mathbf P\_{t/t-1}\mathbf x_t\right)\left(\mathbf P\_{t/t-1}\mathbf x_t\right)^T $$

**P**<sub>*t*/*t*</sub><sup>−1</sup> = **P**<sub>*t*/*t* − 1</sub><sup>−1</sup> + 2*λ*(*ξ*<sub>*t*</sub>)**x**<sub>*t*</sub>**x**<sub>*t*</sub><sup>*T*</sup>

一段予測推定値 $\hat{\mathbf w}\_{t/t-1}$ を使う変分パラメータ (pre)
$$\xi_t=\sqrt{\mathbf x_t^T\left(\mathbf P\_{t/t-1}+\hat{\mathbf w}\_{t/t-1}\hat{\mathbf w}\_{t/t-1}^T\right)\mathbf x_t}$$

濾波推定値 $\hat{\mathbf w}\_{t/t}$ を使う変分パラメータ (EM)
$$\xi_t=\sqrt{\mathbf x_t^T\left(\mathbf P\_{t/t}+\hat{\mathbf w}\_{t/t}\hat{\mathbf w}\_{t/t}^T\right)\mathbf x_t}$$

各変数の情報の利用

<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th><span class="math inline"> </span></th>
<th><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em></sub></span></th>
<th><span class="math inline">$\hat{\mathbf w}_{t/t}$</span></th>
<th><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em> − 1</sub></span></th>
<th><span class="math inline">$\hat{\mathbf w}_{t/t-1}$</span></th>
<th><span
class="math inline"><strong>x</strong><sub><em>t</em></sub></span></th>
<th><span
class="math inline"><em>y</em><sub><em>t</em></sub></span></th>
<th><span
class="math inline"><em>ξ</em><sub><em>t</em></sub></span></th>
</tr>
</thead>
<tbody>
<tr>
<td><span
class="math inline"><strong>P</strong><sub><em>t</em>/<em>t</em></sub></span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
</tr>
<tr>
<td><span class="math inline">$\hat{\mathbf w}_{t/t}$</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
</tr>
<tr>
<td><span class="math inline"><em>ξ</em><sub><em>t</em></sub></span>
(pre)</td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
</tr>
<tr>
<td><span class="math inline"><em>ξ</em><sub><em>t</em></sub></span>
(EM)</td>
<td><span class="math inline">○</span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline">○</span></td>
<td><span class="math inline"> </span></td>
<td><span class="math inline"> </span></td>
</tr>
</tbody>
</table>

## 関数等

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/VA.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### lam

``` python

def lam(
    x:Float[Array, ''], # $x$
)->Float[Array, '']: # $\lambda(x)$

```

\* \*\* Lambda 関数
$$\lambda(x)=\frac{1}{2x}\left\[\sigma(x)-\frac{1}{2}\right\]$$
\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/EKF.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### Ptt

``` python

def Ptt(
    Ptm:Float[Array, 'N N'], # $\mathbf P_{t/t-1}$
    x:Float[Array, 'N'], # $\mathbf x_t$
    xi:Float[Array, ''], # $\xi_t$
)->Float[Array, 'N N']: # $\mathbf P_{t/t}$

```

\* \*\* 推定誤差共分散行列 **P**<sub>*t*/*t*</sub>

$$\mathbf P\_{t/t}=\mathbf P\_{t/t-1}-\frac{2\lambda(\xi_t)}{1+2\lambda(\xi_t)\mathbf x_t^T\mathbf P\_{t/t-1}\mathbf x_t}\left(\mathbf P\_{t/t-1}\mathbf x_t\right)\left(\mathbf P\_{t/t-1}\mathbf x_t\right)^T $$

**P**<sub>*t*/*t*</sub><sup>−1</sup> = **P**<sub>*t*/*t* − 1</sub><sup>−1</sup> + 2*λ*(*ξ*<sub>*t*</sub>)**x**<sub>*t*</sub>**x**<sub>*t*</sub><sup>*T*</sup>
\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/EKF.py#L35"
target="_blank" style="float:right; font-size:smaller">source</a>

### wtt

``` python

def wtt(
    Ptm:Float[Array, 'N N'], # $\mathbf P_{t/t-1}$
    Ptt_:Float[Array, 'N N'], # $\mathbf P_{t/t}$
    w:Float[Array, 'N'], # $\hat{\mathbf w}_{t/t-1}$
    x:Float[Array, 'N'], # $\mathbf x_t$
    y:Float[Array, ''], # $y_t$
)->Float[Array, 'N']: # $\hat{\mathbf w}_{t/t}$

```

\* \*\* 濾波推定値 $\hat{\mathbf w}\_{t/t}$
$$\hat{\mathbf w}\_{t/t}=\mathbf P\_{t/t}\left(\mathbf P\_{t/t-1}^{-1}\hat{\mathbf w}\_{t/t-1}+(y_t-1/2)\mathbf x_t\right)$$
\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/VA.py#L63"
target="_blank" style="float:right; font-size:smaller">source</a>

### xit

``` python

def xit(
    Cov:Float[Array, 'N N'], # $\boldsymbol\Sigma$
    w:Float[Array, 'N'], # $\hat{\mathbf w}$
    x:Float[Array, 'N'], # $\mathbf x_t$
)->Float[Array, '']: # $\xi_t$

```

\* \*\* 変分パラメータ *ξ*<sub>*t*</sub>
$$\xi_t=\sqrt{\mathbf x_t^T\mathbb E\[\mathbf w\mathbf w^T\]\mathbf x_t}=\sqrt{\mathbf x_t^T\left(\boldsymbol \Sigma+\hat{\mathbf w}\hat{\mathbf w}^T\right)\mathbf x_t}$$
\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/VA.py#L75"
target="_blank" style="float:right; font-size:smaller">source</a>

### VApre_out

``` python

def VApre_out(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

\* \*\*
[`VApre`](https://SuzuSys.github.io/KalmanPaper/VA/va.html#vapre)
関数の返り値

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th><span class="math inline"> </span></th>
<th>Type</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>W</td>
<td>Float[Array, ‘T N’]</td>
<td><span class="math inline">$\{\hat{\mathbf
w}_{t/t}\}_{t=0,\ldots,T-1}$</span></td>
</tr>
<tr>
<td>P</td>
<td>Float[Array, ‘T N N’]</td>
<td><span
class="math inline">{<strong>P</strong><sub><em>t</em>/<em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
<tr>
<td>Xi</td>
<td>Float[Array, ‘T’]</td>
<td><span
class="math inline">{<em>ξ</em><sub><em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
</tbody>
</table>

\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/VA.py#L93"
target="_blank" style="float:right; font-size:smaller">source</a>

### VApre

``` python

def VApre(
    N:int, # $N$
    T:int, # $T$
    x:Float[Array, '{T} {N}'], # $\{ \mathbf x_t \}_{t=0,\ldots,T-1}$
    y:Float[Array, '{T}'], # $\{ y_t \}_{t=0,\ldots,T-1}$
    G:Float[Array, '{N} {N}'], # $\boldsymbol\Gamma$
    w0:Float[Array, '{N}'], # $\hat{\mathbf w}_{0/-1}$
    P0:Float[Array, '{N} {N}'], # $\mathbf P_{0/-1}$
)->VApre_out:

```

\* \*\* 一段予測推定値 $\hat{\mathbf w}\_{t/t-1}$ を使う変分近似法
$$\xi_t=\sqrt{\mathbf x_t^T\left(\mathbf P\_{t/t-1}+\hat{\mathbf w}\_{t/t-1}\hat{\mathbf w}\_{t/t-1}^T\right)\mathbf x_t}$$
\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/VA.py#L136"
target="_blank" style="float:right; font-size:smaller">source</a>

### VAEM_out

``` python

def VAEM_out(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

\* \*\* [`VAEM`](https://SuzuSys.github.io/KalmanPaper/VA/va.html#vaem)
関数の返り値

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th><span class="math inline"> </span></th>
<th>Type</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>W</td>
<td>Float[Array, ‘T N’]</td>
<td><span class="math inline">$\{\hat{\mathbf
w}_{t/t}\}_{t=0,\ldots,T-1}$</span></td>
</tr>
<tr>
<td>P</td>
<td>Float[Array, ‘T N N’]</td>
<td><span
class="math inline">{<strong>P</strong><sub><em>t</em>/<em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
<tr>
<td>Xi</td>
<td>Float[Array, ‘T’]</td>
<td><span
class="math inline">{<em>ξ</em><sub><em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
<tr>
<td>Iters</td>
<td>Int[Array, ‘T’]</td>
<td><span
class="math inline">{Iter<sub><em>t</em></sub>}<sub><em>t</em> = 0, …, <em>T</em> − 1</sub></span></td>
</tr>
</tbody>
</table>

\* 

------------------------------------------------------------------------

<a
href="https://github.com/SuzuSys/KalmanPaper/blob/main/KalmanPaper/VA.py#L157"
target="_blank" style="float:right; font-size:smaller">source</a>

### VAEM

``` python

def VAEM(
    N:int, # $N$
    T:int, # $T$
    x:Float[Array, '{T} {N}'], # $\{ \mathbf x_t \}_{t=0,\ldots,T-1}$
    y:Float[Array, '{T}'], # $\{ y_t \}_{t=0,\ldots,T-1}$
    G:Float[Array, '{N} {N}'], # $\boldsymbol\Gamma$
    w0:Float[Array, '{N}'], # $\hat{\mathbf w}_{0/-1}$
    P0:Float[Array, '{N} {N}'], # $\mathbf P_{0/-1}$
    epsilon:Float[Array, ''], # $\epsilon\ge |\xi\\^{\text{new}}_t-\xi\\^{\text{old}}_t|$
    max_iter:int=100, # 繰り返し回数の上限
)->VAEM_out:

```

\* \*\* 濾波推定値 $\hat{\mathbf w}\_{t/t}$
を使う変分近似法。EMアルゴリズムを使う。
$$\xi_t=\sqrt{\mathbf x_t^T\left(\mathbf P\_{t/t}+\hat{\mathbf w}\_{t/t}\hat{\mathbf w}\_{t/t}^T\right)\mathbf x_t}$$
\* 
